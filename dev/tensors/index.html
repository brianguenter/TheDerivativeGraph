<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tensor Derivatives · TheDerivativeGraph</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">TheDerivativeGraph</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">The Derivative Graph and its use</a></li><li><a class="tocitem" href="../thederivativegraph/">The Derivative Graph</a></li><li class="is-active"><a class="tocitem" href>Tensor Derivatives</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tensor Derivatives</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tensor Derivatives</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/brianguenter/TheDerivativeGraph/blob/main/docs/src/tensors.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><p>Computing tensor derivatives is conceptually simple, at least for tensor operations that can be represented as sequences of tensor contractions, e.g., <span>$Ab = \sum\limits_{j} A_{ij}b{j}$</span> which applies tensor contraction to the <span>$j$</span> index. From now on we&#39;ll use the notation <span>$A_{ij}b{j}$</span> to mean <span>$\sum\limits_{j} A_{ij}b{j}$</span></p><p>Differentiation proceeds in simple steps:</p><ul><li>Explicitly mark the indices on all tensor terms. Indices shared between two or more terms indicate a tensor contraction.</li><li>Transform the tensor expression into a function graph.</li><li>Transform the function graph into a derivative graph. Change tensor contractions into summation operation nodes.</li><li>Find the variable being differentiated with respect to and compute index substitutions. </li><li>Propagate the index substitutions up the graph.</li></ul><p>Let&#39;s do several examples first, before going into the details of why this works. The first example is compute <span>$\frac{\partial f_i}{\partial A-{mn}}$</span> for <span>$f_i = A_{ij}b_j$</span>. </p><p>Begin by creating the function graph corresponding to the expression <span>$f_i = A_{ij}b_j$</span></p><p><img src="../illustrations/Ab/Ab_illustration.svg" alt="Ab"/></p><p>Then transform this into a derivative graph, where <span>$Df_{imn}$</span> refers to the derivative of <span>$f$</span> indexed at <span>$imn$</span>,</p><p><img src="../illustrations/Ab/Ab_illustrationD.svg" alt="Ab_deriv"/></p><p>The variable being differentiated wrt is <span>$A_{mn}$</span>. Create the substitution <span>$sub((i=&gt;m,j=&gt;n))$</span> and apply it to the graph nodes and edges on the product path from <span>$f_i$</span> to <span>$A_{mn}$</span>, beginning with <span>$A_{mn}$</span> and working upward:</p><p><img src="../illustrations/Ab/Ab_partial_Aij_step1D.svg" alt="Ab_deriv1"/> <img src="../illustrations/Ab/Ab_partial_Aij_step2D.svg" alt="Ab_deriv2"/> <img src="../illustrations/Ab/Ab_partial_Aij_step3D.svg" alt="Ab_deriv3"/></p><p><img src="../illustrations/Ab/Ab_partial_Aij_step4D.svg" alt="Ab_deriv4"/> <img src="../illustrations/Ab/Ab_partial_Aij_step5D.svg" alt="Ab_deriv5"/></p><p>Notice that the substition <span>$sub((i=&gt;m,j=&gt;n),\sum\limits{j})$</span> collapses to a no-op. This is because the summation is zero except when <span>$j=n$</span>; there is only one term in the summation. </p><p>Now multiply all the terms on the product path from <span>$f_{mmn}=\frac{\partial f_i}{\partial A-{mn}}$</span> to <span>$A_{mn}$</span>. This product is <span>$Df_{i=m,mmn} = 1*1*b_n = b_n$</span>. Although the result has three indices <span>$Df_{i=m,mn}$</span> there is an equality constraint on the first index, create by the substition rule <span>$sub((i=&gt;m,i=&gt;n),...)$</span>. Only indices which satisfy this constraint are non-zero. For example<span>$Df[1,1,1]=b_1$</span> but <span>$Df[1,2,1]=0$</span> because the first two indices are not equal. </p><p>Even though the derivative is 3 dimensional the only non-zero elements of this tensor are the elements of <span>$b_n$</span> so storing the tensor takes space proportional to the size of <span>$b_n$</span>.</p><p>Here&#39;s a FastDifferentiation function to compute the derivative symbolically:</p><pre><code class="language-julia hljs">function Ab()
    A = make_variables(:A, 2, 2)
    b = make_variables(:b, 2)

    jac = jacobian(FD.Node.(A * b), vec(A))
    reshape(jac, 2, 2, 2)
end
export Ab</code></pre><p>and here&#39;s the evaluation:</p><pre><code class="language-julia hljs">julia&gt; Ab()
2×2×2 Array{FastDifferentiation.Node, 3}:
[:, :, 1] =
  b1  0.0
 0.0   b1

[:, :, 2] =
  b2  0.0
 0.0   b2</code></pre><p>As expected the derivative is non-zero only when the first two indices are equal.</p><p>As for computation let&#39;s compute the product </p><p>LATER Also note that the order of the summations in the product <span>$f_{imn}x_{im}$</span> </p><p class="math-container">\[\begin{aligned}
f_{imn}x_{im} &amp;= \sum\limits_{i} \sum\limits_{m} \sum\limits_{n} b_n x_{im} \\
&amp;=  \sum\limits_{n} b_n \sum\limits_{i} \sum\limits_{m} x_{im}
\end{aligned}\]</p><p>can be rearranged to take <span>$im+b$</span> multiplications rather than <span>$imb$</span> multiplications if summed in the original order. Memory and compute efficiency are two key advantages of the explicit index representation.</p><p class="math-container">\[\frac{\partial b_j}{\partial b_k} = \begin{cases}
0  &amp; j \ne k, \\
1 &amp; j=k
\end{cases}\]</p><p>Operations are scalar once they have been converted to index form. Product terms can be computed in any order (Example). This gives the AD algorithm designer great flexibility in deciding how to schedule operations on the processor.</p><p>In the first example the summation operator <span>$\sum\limits_{j}$</span> disappeared because the summation index and the substitution index were the same. The summation is only non-zero when the summation index equals the substitution so the summation collapse to a single term. </p><p>The next example shows a case where this is not true. Given function <span>$f_k = B_{ki}A_{ij}x_j$</span> compute <span>$\frac{\partial f_k}{\partial x_n}$</span>.</p><p>The illustrations show the differentiation starting from the original function graph on the left to the final derivative on the right. At each step the substitution operation ascends one level in the graph.</p><p>This is the function graph corresponding to <span>$f_k = B_{ki}A_{ij}x_j$</span> <img src="../illustrations/BAx/BAx_illustration.svg" alt="BAx"/></p><p>The differentiation steps are shown in order from left to right. First the substitution variables are found by locating the variable node. In each succeeding step the substitution ascends one level in the graph.</p><p><img src="../illustrations/BAx/BAx_partial_xj_step1D.svg" alt="BAx partial"/> <img src="../illustrations/BAx/BAx_partial_xj_step2D.svg" alt="BAx partial"/></p><p>The final derivative is shown at the far right in the figure below.</p><p><img src="../illustrations/BAx/BAx_partial_xj_step3D.svg" alt="BAx partial"/> <img src="../illustrations/BAx/BAx_partial_xj_step4D.svg" alt="BAx partial"/></p><p>In equation form</p><p class="math-container">\[\frac{\partial f_k}{\partial x_n} = \sum\limits_{i} B_{ki}A_{in}\]</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../thederivativegraph/">« The Derivative Graph</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Friday 25 August 2023 19:36">Friday 25 August 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
